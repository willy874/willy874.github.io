# Agent Platform - 產品規格書

## 一、User Stories

---

## 二、功能需求

### 2.1 登入頁面 (Login)

#### 2.1.1 顯示欄位

**頁面元素**

- 「登入」標題
- 登入表單送出按鈕
- 忘記密碼連結按鈕

#### 2.1.2 表單填寫欄位及驗證規則

**資料驗證**

| Column   | Type | Required | Description |
| -------- | ---- | -------- | ----------- |
| Account  | Text | true     |             |
| Password | Text | true     |             |

#### 2.1.3 Action Flow

```mermaid
flowchart TD
    A[進入登入頁面] --> B[顯示登入表單]
    B --> C[使用者輸入帳號密碼]
    C --> D[點擊登入按鈕]
    D --> E[驗證欄位是否填寫]
    E -->|欄位空白| F[顯示必填提示]
    E -->|欄位完整| G[送出登入請求]
    G --> H[伺服器驗證帳號密碼]
    H -->|驗證失敗| I[顯示帳號或密碼錯誤]
    H -->|驗證成功| J[檢查帳號狀態]
    J -->|帳號凍結/鎖定| K[顯示帳號狀態錯誤]
    J -->|帳號正常| L[檢查設備註冊狀態]
    L -->|設備未註冊| M[導向設備註冊流程]
    L -->|設備已註冊| N[登入成功]
    N --> O[導向主頁面]
    F --> C
    I --> C
    K --> C
    M --> P[完成設備註冊]
    P --> O
```

#### 2.1.4 商業邏輯

1. **表單驗證**

   - 帳號和密碼為必填欄位
   - 不進行任何格式驗證，由後端驗證
   - 如果帳號凍結、上鎖均無法登入

2. **登入邏輯**

   - 支援帳號密碼登入
   - 登入成功後檢查設備註冊狀態
   - 新設備需要完成註冊流程
   - 登入失敗會記錄嘗試次數，多次失敗會暫時鎖定

#### 2.1.5 權限設計

| Operator | Permission | Description                        |
| -------- | ---------- | ---------------------------------- |
| 登入系統 | -          | 無權限限制，所有使用者都可嘗試登入 |


### 2.2 忘記密碼頁面 (Forget Password)

#### 2.2.1 顯示欄位

**頁面元素**

- 頁面標題 "忘記密碼"
- 帳號輸入欄位
- 發送重設密碼信按鈕
- 返回登入按鈕

**說明文字**

- 請輸入您的帳號，我們將寄送重設密碼信到您的信箱
- 重設密碼信有效期限為 1 小時

#### 2.2.2 表單填寫欄位及驗證規則

**重設密碼表單**

| Column  | Type | Required | Rule       | Description |
| ------- | ---- | -------- | ---------- | ----------- |
| Account | Text | true     | Email 格式 | 系統帳號    |

**驗證規則**

- 帳號必填且需為有效的 Email 格式
- 系統會驗證帳號是否存在於資料庫中

#### 2.2.3 Action Flow

```mermaid
flowchart TD
    A[進入忘記密碼頁面] --> B[顯示重設表單]
    B --> C[使用者輸入帳號]
    C --> D[點擊發送重設密碼信]
    D --> E[驗證帳號格式]
    E -->|格式錯誤| F[顯示格式錯誤提示]
    E -->|格式正確| G[檢查帳號是否存在]
    G -->|帳號不存在| H[顯示帳號不存在提示]
    G -->|帳號存在| I[檢查帳號狀態]
    I -->|帳號被鎖定/停用| J[顯示帳號狀態錯誤]
    I -->|帳號正常| K[產生重設密碼 Token]
    K --> L[寄送重設密碼信]
    L -->|寄送成功| M[顯示寄送成功訊息]
    L -->|寄送失敗| N[顯示寄送失敗提示]
    M --> O[使用者到信箱點擊連結]
    O --> P[驗證 Token 有效性]
    P -->|Token 無效/過期| Q[顯示連結失效]
    P -->|Token 有效| R[進入重設密碼頁面]
    R --> S[設定新密碼]
    S --> T[密碼重設成功]
    T --> U[導向登入頁面]
    F --> C
    H --> C
    J --> C
    N --> C
```

#### 2.2.4 商業邏輯

1. **重設流程**

   - 使用者輸入帳號後，系統產生唯一的重設 Token
   - 重設密碼信有效期限為 1 小時
   - Token 只能使用一次，使用後自動失效

2. **安全機制**

   - 同一帳號 10 分鐘內只能申請一次重設
   - 重設密碼信包含安全連結，不可轉發
   - 新密碼設定後會強制登出所有設備

3. **信件邏輯**

   - 重設密碼信寄送到帳號對應的 Email
   - 信件內容包含重設連結和有效時限說明
   - 每次申請重設會註銷前一個未使用的 Token

4. **密碼設定**

   - 新密碼需符合強度要求
   - 設定完成後需要重新登入驗證


---

### 2.3 主頁面 (Home)

#### 2.3.1 顯示欄位

**頁面元素**

- 頁面標題 "主頁面"
- 使用者名稱顯示
- 請求開通按鈕
- 上傳開通金鑰按鈕
- 主選單按鈕
- 啟動/關閉連線按鈕
- 連線狀態文字
- 最後登入時間文字
- 裝置名稱文字

**狀態資訊**

| Column             | Description    | Display Condition |
| ------------------ | -------------- | ----------------- |
| Username           | 登入使用者名稱 | 所有狀態          |
| Connection Status  | 連線狀態       | 已開通設備        |
| Last Login Time    | 最後登入時間   | 已開通設備        |
| Device Name        | 目前裝置名稱   | 已開通設備        |
| Connection Control | 連線控制按鈕   | 已開通設備        |

#### 2.3.2 表單填寫欄位及驗證規則

**上傳金鑰表單**

| Column   | Type | Required | Rule                 | Description  |
| -------- | ---- | -------- | -------------------- | ------------ |
| Key File | File | true     | 支援格式：.key, .pem | 開通金鑰檔案 |

**驗證規則**

- 金鑰檔案必填且格式正確
- 檔案大小限制 1MB 以內
- 系統會驗證金鑰有效性

#### 2.3.3 Action Flow

```mermaid
flowchart TD
    A[進入主頁面] --> B[檢查設備狀態]
    B --> C{設備狀態}
    C -->|待開通| D[顯示開通相關按鈕]
    C -->|已開通| E[顯示連線相關功能]
    D --> F[使用者選擇操作]
    F --> G{操作類型}
    G -->|請求開通| H[發送開通請求]
    G -->|上傳金鑰| I[選擇金鑰檔案]
    G -->|主選單| J[進入選單頁面]
    H --> K[等待管理員審核]
    I --> L[驗證金鑰格式]
    L -->|驗證失敗| M[顯示格式錯誤]
    L -->|驗證成功| N[上傳金鑰]
    N -->|上傳成功| O[設備開通成功]
    N -->|上傳失敗| P[顯示上傳失敗]
    E --> Q[顯示連線控制]
    Q --> R[使用者操作]
    R --> S{連線操作}
    S -->|啟動連線| T[建立VPN連線]
    S -->|關閉連線| U[中斷VPN連線]
    S -->|主選單| J
    T -->|連線成功| V[更新連線狀態]
    T -->|連線失敗| W[顯示連線錯誤]
    U --> X[更新為未連線狀態]
    O --> E
    K --> Y[等待開通完成]
    Y --> E
```

#### 2.3.4 商業邏輯

1. **頁面狀態管理**

   - **待開通狀態**

     - 未被開通的設備顯示開通相關功能
     - 隱藏連線狀態文字、啟動/關閉連線按鈕、最後登入時間文字、裝置名稱文字
     - 顯示請求開通按鈕和上傳開通金鑰按鈕

   - **已開通狀態**
     - 已開通設備顯示連線相關功能
     - 隱藏請求開通按鈕、上傳開通金鑰按鈕
     - 顯示連線狀態、控制按鈕和設備資訊

2. **連線狀態管理**

   - **未連線**：可以點擊啟動連線
   - **連線中**：顯示連線進度，無法操作
   - **已連線**：可以點擊關閉連線，顯示連線時間

3. **開通邏輯**

   - 請求開通：發送申請給管理員，等待審核
   - 上傳金鑰：直接上傳有效金鑰完成開通
   - 開通成功後立即切換到已開通狀態

4. **安全機制**

   - 連線時建立加密隧道
   - 定期檢查連線健康狀態
   - 異常斷線時自動嘗試重連


### 2.4 選單 (Menu)

#### 2.4.1 顯示欄位

**頁面元素**

- 頁面標題 "選單"
- 連結個人中心按鈕
- 連結幫助中心按鈕
- 登出按鈕
- 回到首頁按鈕

**功能選項**

| Option   | Description        | Action           |
| -------- | ------------------ | ---------------- |
| 個人中心 | 檢視和管理個人資訊 | 導向個人中心頁面 |
| 幫助中心 | 獲取使用說明和支援 | 導向幫助中心頁面 |
| 登出     | 登出目前帳號       | 執行登出流程     |
| 回到首頁 | 返回主頁面         | 導向首頁         |

#### 2.4.2 表單填寫欄位及驗證規則

**操作驗證**

- 所有操作均無需表單填寫
- 登出操作需確認對話框

#### 2.4.3 Action Flow

```mermaid
flowchart TD
    A[進入選單頁面] --> B[顯示選單選項]
    B --> C[使用者選擇操作]
    C --> D{操作類型}
    D -->|個人中心| E[檢查存取權限]
    D -->|幫助中心| F[檢查存取權限]
    D -->|登出| G[顯示確認對話框]
    D -->|回到首頁| H[直接導向首頁]
    E -->|有權限| I[進入個人中心]
    E -->|無權限| J[顯示權限不足訊息]
    F -->|有權限| K[進入幫助中心]
    F -->|無權限| J
    G -->|確認登出| L[執行登出流程]
    G -->|取消| B
    L --> M[清除使用者資料]
    M --> N[導向登入頁面]
    H --> O[返回主頁面]
```

#### 2.4.4 商業邏輯

1. **選單邏輯**

   - 所有操作均為導覽性質，不涉及資料修改

2. **登出邏輯**

   - 登出前顯示確認對話框
   - 清除本機儲存的使用者資料
   - 撤銷目前的認證 Token
   - 中斷所有進行中的連線


---

### 2.5 個人中心 (Profile)

#### 2.5.1 顯示欄位

**頁面元素**

- 頁面標題 "個人中心"
- 連結重設密碼按鈕
- 啟動 2FA 按鈕
- 停用 2FA 按鈕
- 允許服務列表
- 回到選單按鈕

**個人資訊**

| Column      | Description        |
| ----------- | ------------------ |
| Account     | 系統帳號名稱       |
| Nickname    | 顯示名稱           |
| 2FA Status  | 雙因素認證狀態     |
| Last Login  | 最後登入時間       |
| Device Name | 目前設備名稱       |
| Services    | 允許存取的服務列表 |

**操作選項**

| Operator | Allow Condition | Description    |
| -------- | --------------- | -------------- |
| 重設密碼 | 任何時候        | 修改登入密碼   |
| 啟動 2FA | 2FA 未啟動      | 啟動雙因素認證 |
| 停用 2FA | 2FA 已啟動      | 停用雙因素認證 |

#### 2.5.2 Action Flow

```mermaid
flowchart TD
    A[進入個人中心] --> B[檢查存取權限]
    B -->|無權限| C[顯示權限不足訊息]
    B -->|有權限| D[載入個人資訊]
    D --> E[顯示個人資料]
    E --> F[使用者選擇操作]
    F --> G{操作類型}
    G -->|重設密碼| H[進入密碼重設流程]
    G -->|啟動2FA| I[檢查2FA狀態]
    G -->|停用2FA| J[檢查2FA狀態]
    G -->|回到選單| K[返回選單頁面]
    H --> L[驗證目前密碼]
    L -->|驗證失敗| M[顯示密碼錯誤]
    L -->|驗證成功| N[輸入新密碼]
    N --> O[驗證密碼強度]
    O -->|驗證失敗| P[顯示格式要求]
    O -->|驗證成功| Q[更新密碼]
    I -->|已啟動| R[顯示狀態錯誤]
    I -->|未啟動| S[顯示2FA啟動流程]
    J -->|未啟動| R
    J -->|已啟動| T[確認停用對話框]
    S --> U[掃描QR碼設定]
    U --> V[驗證2FA碼]
    V -->|驗證成功| W[啟動成功]
    V -->|驗證失敗| X[顯示驗證錯誤]
    T --> Y[執行停用2FA]
    Q --> Z[密碼更新成功]
    W --> AA[更新頁面狀態]
    Y --> AA
    Z --> AA
    M --> H
    P --> N
    X --> U
```

#### 2.5.3 商業邏輯

1. **個人資訊顯示**

   - 顯示使用者基本資訊（唯讀）
   - 顯示目前 2FA 啟動狀態
   - 顯示允許存取的應用程式列表
     - 顯示 Application Name, Application Host + Port

2. **密碼重設邏輯**

   - 必須去信箱收重置密碼信
   - 密碼更新後強制重新登入所有設備

3. **2FA 管理邏輯**

   - 啟動 2FA：產生 QR 碼，使用者掃描後驗證
   - 停用 2FA：需要確認對話框
   - 2FA 狀態變更後立即生效

4. **服務列表邏輯**

   - 顯示使用者有權限存取的所有服務
   - 服務狀態為唯讀，由系統管理員設定


---

### 2.6 幫助中心 (Help Center)

#### 2.6.1 顯示欄位

**頁面元素**

- 頁面標題 "幫助中心"
- 客戶服務按鈕
- 連結配置頁面按鈕
- 連結開發者頁面按鈕
- 回到選單按鈕

**幫助選項**

| Option     | Description        | Action             |
| ---------- | ------------------ | ------------------ |
| 客戶服務   | 聯絡客服團隊       | 開啟客服聊天或郵件 |
| 使用說明   | 檢視產品使用指南   | 導向使用說明頁面   |
| 配置頁面   | 系統配置說明       | 導向配置說明頁面   |
| 開發者頁面 | API 文件和開發資源 | 導向開發者文件     |
| 常見問題   | FAQ 列表           | 顯示常見問題解答   |
| 回到選單   | 返回主選單         | 導向選單頁面       |

#### 2.6.2 表單填寫欄位及驗證規則

**客戶服務表單**

| Column        | Type     | Required | Rule             | Description |
| ------------- | -------- | -------- | ---------------- | ----------- |
| Subject       | Text     | true     | 最大長度 100 字  | 問題主旨    |
| Category      | Select   | true     | 選擇問題類型     | 問題分類    |
| Description   | Textarea | true     | 最大長度 1000 字 | 詳細描述    |
| Contact Email | Email    | true     | Email 格式       | 聯絡信箱    |

**問題分類**

- 技術問題
- 帳號問題
- 連線問題
- 功能建議
- 其他

#### 2.6.3 Action Flow

```mermaid
flowchart TD
    A[進入幫助中心] --> B[顯示幫助選項]
    B --> C[使用者選擇功能]
    C --> D{功能類型}
    D -->|客戶服務| E[開啟客服表單]
    D -->|使用說明| F[載入使用指南]
    D -->|配置頁面| G[載入配置說明]
    D -->|開發者頁面| H[載入開發文件]
    D -->|常見問題| I[顯示FAQ列表]
    D -->|回到選單| J[返回選單頁面]
    E --> K[填寫問題資訊]
    K --> L[驗證表單]
    L -->|驗證失敗| M[顯示錯誤訊息]
    L -->|驗證成功| N[送出客服請求]
    N -->|成功| O[顯示送出成功訊息]
    N -->|失敗| P[顯示送出失敗訊息]
    F --> Q[顯示使用指南內容]
    G --> R[顯示配置說明內容]
    H --> S[顯示開發文件內容]
    I --> T[顯示FAQ內容]
    M --> K
    P --> K
```

#### 2.6.4 商業邏輯

1. **幫助內容邏輯**

   - 根據使用者類型顯示相關幫助內容
   - 開發者頁面需要開發者權限才能存取
   - 配置頁面需要管理員權限才能存取

2. **客戶服務邏輯**

   - 客服表單提交後自動產生工單編號
   - 系統會自動記錄使用者資訊
   - 客服回覆會寄送到聯絡信箱

