import{__toESM as e,require_react as t}from"./iframe-BrZWt-XD.js";import{require_jsx_runtime as n}from"./jsx-runtime-BNG85-6G.js";import{require_react_dom as r}from"./react-dom-C4w7aAI6.js";import{INIT_STATE as i,MachineStatus as a,compact as o,createScope as s,ensure as c,identity as l,isFunction as u,isString as d,toArray as f,warn as p}from"./dist-20u2P0-x.js";function m(e){return new Proxy({},{get(t,n){return n===`style`?t=>e({style:t}).style:e}})}var h=()=>e=>Array.from(new Set(e)),g=e(t(),1),_=e(r(),1),v=e(n(),1),y=globalThis.document===void 0?g.useEffect:g.useLayoutEffect;function b(e){let t=e().value??e().defaultValue,n=e().isEqual??Object.is,[r]=(0,g.useState)(t),[i,a]=(0,g.useState)(r),o=e().value!==void 0,s=(0,g.useRef)(i);s.current=o?e().value:i;let c=(0,g.useRef)(s.current);y(()=>{c.current=s.current},[i,e().value]);let d=t=>{var r,i;let s=c.current,l=u(t)?t(s):t;e().debug&&console.log(`[bindable > ${e().debug}] setValue`,{next:l,prev:s}),o||a(l),n(l,s)||(r=(i=e()).onChange)?.call(i,l,s)};function f(){return o?e().value:i}return{initial:r,ref:s,get:f,set(t){let n=e().sync?_.flushSync:l;n(()=>d(t))},invoke(t,n){var r,i;(r=(i=e()).onChange)?.call(i,t,n)},hash(t){var n,r;return(n=(r=e()).hash)?.call(r,t)??String(t)}}}b.cleanup=e=>{(0,g.useEffect)(()=>e,[])},b.ref=e=>{let t=(0,g.useRef)(e);return{get:()=>t.current,set:e=>{t.current=e}}};function x(e){let t=(0,g.useRef)(e);return{get(e){return t.current[e]},set(e,n){t.current[e]=n}}}var S=(e,t)=>{let n=(0,g.useRef)(!1),r=(0,g.useRef)(!1);(0,g.useEffect)(()=>{let e=n.current,i=e&&r.current;if(i)return t();r.current=!0},[...(e??[]).map(e=>typeof e==`function`?e():e)]),(0,g.useEffect)(()=>(n.current=!0,()=>{n.current=!1}),[])};function C(e,t={}){var n,r,l,m;let h=(0,g.useMemo)(()=>{let{id:e,ids:n,getRootNode:r}=t;return s({id:e,ids:n,getRootNode:r})},[t]),v=(...t)=>{e.debug&&console.log(...t)},C=(n=e.props)?.call(e,{props:o(t),scope:h})??t,D=T(C),O=(r=e.context)?.call(e,{prop:D,bindable:b,scope:h,flush:E,getContext(){return A},getComputed(){return U},getRefs(){return L},getEvent(){return F()}}),k=w(O),A={get(e){var t;return(t=k.current)?.[e].ref.current},set(e,t){var n;(n=k.current)?.[e].set(t)},initial(e){var t;return(t=k.current)?.[e].initial},hash(e){var t,n;let r=(t=k.current)?.[e].get();return(n=k.current)?.[e].hash(r)}},j=(0,g.useRef)(new Map),M=(0,g.useRef)(null),N=(0,g.useRef)(null),P=(0,g.useRef)({type:``}),F=()=>({...P.current,current(){return P.current},previous(){return N.current}}),I=()=>({...W,matches(...e){return e.includes(W.ref.current)},hasTag(t){var n;return!!(!((n=e.states[W.ref.current])==null||(n=n.tags)==null)&&n.includes(t))}}),L=x((l=e.refs)?.call(e,{prop:D,context:A})??{}),R=()=>({state:I(),context:A,event:F(),prop:D,send:J,action:z,guard:B,track:S,refs:L,computed:U,flush:E,scope:h,choose:H}),z=t=>{let n=u(t)?t(R()):t;if(!n)return;let r=n.map(t=>{var n;let r=(n=e.implementations)==null||(n=n.actions)==null?void 0:n[t];return r||p(`[zag-js] No implementation found for action "${JSON.stringify(t)}"`),r});for(let e of r)e?.(R())},B=t=>{var n;return u(t)?t(R()):(n=e.implementations)==null||(n=n.guards)==null?void 0:n[t](R())},V=t=>{let n=u(t)?t(R()):t;if(!n)return;let r=n.map(t=>{var n;let r=(n=e.implementations)==null||(n=n.effects)==null?void 0:n[t];return r||p(`[zag-js] No implementation found for effect "${JSON.stringify(t)}"`),r}),i=[];for(let e of r){let t=e?.(R());t&&i.push(t)}return()=>i.forEach(e=>e?.())},H=e=>f(e).find(e=>{let t=!e.guard;return d(e.guard)?t=!!B(e.guard):u(e.guard)&&(t=e.guard(R())),t}),U=t=>{c(e.computed,()=>`[zag-js] No computed object found on machine`);let n=e.computed[t];return n({context:A,event:F(),prop:D,refs:L,scope:h,computed:U})},W=b(()=>({defaultValue:e.initialState({prop:D}),onChange(t,n){var r,a,o,s;if(n){let e=j.current.get(n);e?.(),j.current.delete(n)}n&&z((r=e.states[n])?.exit),z((a=M.current)?.actions);let c=V((o=e.states[t])?.effects);if(c&&j.current.set(t,c),n===i){z(e.entry);let t=V(e.effects);t&&j.current.set(i,t)}z((s=e.states[t])?.entry)}})),G=(0,g.useRef)(void 0),K=(0,g.useRef)(a.NotStarted);y(()=>{queueMicrotask(()=>{let e=K.current===a.Started;K.current=a.Started,v(e?`rehydrating...`:`initializing...`);let t=G.current??W.initial;W.invoke(t,e?W.get():i)});let t=j.current,n=W.ref.current;return()=>{v(`unmounting...`),G.current=n,K.current=a.Stopped,t.forEach(e=>e?.()),j.current=new Map,M.current=null,queueMicrotask(()=>{z(e.exit)})}},[]);let q=()=>`ref`in W?W.ref.current:W.get(),J=t=>{queueMicrotask(()=>{var n,r;if(K.current!==a.Started)return;N.current=P.current,P.current=t;let i=q(),o=(n=e.states[i].on)?.[t.type]??(r=e.on)?.[t.type],s=H(o);if(!s)return;M.current=s;let c=s.target??i;v(`transition`,t.type,s.target||i,`(${s.actions})`);let l=c!==i;l?(0,_.flushSync)(()=>W.set(c)):s.reenter&&!l?W.invoke(i,i):z(s.actions??[])})};return(m=e.watch)?.call(e,R()),{state:I(),send:J,context:A,prop:D,scope:h,refs:L,computed:U,event:F(),getStatus:()=>K.current}}function w(e){let t=(0,g.useRef)(e);return t.current=e,t}function T(e){let t=w(e);return function(e){return t.current[e]}}function E(e){queueMicrotask(()=>{(0,_.flushSync)(()=>e())})}var D=m(e=>e),O=e=>{let{children:t,container:n,disabled:r,getRootNode:i}=e,a=typeof window>`u`;if(a||r)return(0,v.jsx)(g.Fragment,{children:t});let o=i?.().ownerDocument??document,s=n?.current??o.body;return(0,v.jsx)(g.Fragment,{children:g.Children.map(t,e=>(0,_.createPortal)(e,s))})};export{O as Portal,h as createProps,D as normalizeProps,C as useMachine};